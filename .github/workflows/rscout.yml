name: RSCout Analysis

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  analyze:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      
    steps:
      - uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install RSCout
        run: npm install -g rscout
        
      - name: Run RSCout Analysis
        id: rscout
        run: |
          # Run analysis and save to file
          npx rscout analyze ./src --format mermaid --output rscout-diagram.md
          npx rscout analyze ./src --format json --output rscout-analysis.json
          
          # Extract stats for PR comment
          TOTAL=$(jq '.stats.totalComponents' rscout-analysis.json)
          SERVER=$(jq '.stats.serverComponents' rscout-analysis.json)
          CLIENT=$(jq '.stats.clientComponents' rscout-analysis.json)
          WARNINGS=$(jq '.warnings | length' rscout-analysis.json)
          
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "server=$SERVER" >> $GITHUB_OUTPUT
          echo "client=$CLIENT" >> $GITHUB_OUTPUT
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT
          
      - name: Comment PR
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const fs = require('fs');
            const mermaidDiagram = fs.readFileSync('rscout-diagram.md', 'utf8');
            const analysisData = JSON.parse(fs.readFileSync('rscout-analysis.json', 'utf8'));
            
            let warningsList = '';
            if (analysisData.warnings.length > 0) {
              warningsList = '\n\n### ⚠️ Warnings\n';
              analysisData.warnings.forEach(w => {
                warningsList += `- ${w.message}\n`;
              });
            }
            
            const comment = `## 🔍 RSCout Analysis
            
            ### 📊 Component Statistics
            - **Total Components**: ${{ steps.rscout.outputs.total }}
            - **Server Components**: ${{ steps.rscout.outputs.server }} 🟦
            - **Client Components**: ${{ steps.rscout.outputs.client }} 🟨
            - **Warnings**: ${{ steps.rscout.outputs.warnings }}
            
            ### 🗺️ Component Dependency Graph
            \`\`\`mermaid
            ${mermaidDiagram}
            \`\`\`
            ${warningsList}
            
            ---
            *Generated by [RSCout](https://github.com/te2wow/rscout)*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });